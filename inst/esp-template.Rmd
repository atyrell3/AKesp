---
title: "Appendix `r params$num`. Ecosystem and Socioeconomic Profile of the `r params$fish` stock in the `r params$region` `r ifelse(params$esp_type == 'report_card', '- Report Card', ifelse(params$esp_type == 'partial', '- Partial Update', ''))`"
author: "`r params$authors`"
date: "Draft `r params$year`"
output: 
  bookdown::word_document2:
    reference_docx: "template.docx" 
    fig_caption: false
    
bibliography: references.bib

params:
  num: 1
  authors: "Kalei Shotwell, Abby Tyrell"
  year: 2022
  contributors: "Kalei Shotwell, Abby Tyrell"
  fish: "Myfish"
  region: "Myarea"
  fig_spreadsheet: "figure_spreadsheet.csv"
  tab_spreadsheet: "table_spreadsheet.csv"
  esp_text: "full-esp-text-template.docx"
  stock_image: "default"
  esp_data: NULL
  con_model_path: "default"
  bayes_path: "default"
  ncolumn: 1
  min_year: NULL
  esp_type: "full"
---

```{r setup, include = FALSE}
# This template can be used to create a full or partial ESP
# The text content is read in from a word document
# The word document should be created based on the template
# Headings and table/figure references must follow specific formatting

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  results = "asis"
)

fig_spreadsheet <- params$fig_spreadsheet
tab_spreadsheet <- params$tab_spreadsheet
ref_spreadsheet <- params$ref_spreadsheet
esp_text <- params$esp_text
con_model_path <- params$con_model_path
bayes_path <- params$bayes_path
stock_image <- params$stock_image

if(stock_image == "default"){
  stock_image <- system.file("images/noaa.jpg", package = "AKesp")
}

if(con_model_path == "default"){
  con_model_path <- system.file("images/noaa.jpg", package = "AKesp")
}

if(bayes_path == "default"){
  bayes_path <- system.file("images/noaa.jpg", package = "AKesp")
}
```

```{r, title-fig}
knitr::include_graphics(path = stock_image)
```

*With Contributions from:*

`r params$contributors`

\newpage

```{r, text-report-card, eval = params$esp_type == "report_card"}
child <- knitr::knit_child(system.file("esp-report-card-child.Rmd", package = "AKesp"),
                  quiet = TRUE)
cat(child, sep = "\n\n")
```

```{r, text, eval = params$esp_type != "report_card"}
if(class(try(readtext::readtext(esp_text)))[1] == "try-error"){
  print("Can't find text template!")
} else {
  temp_file <- "temp-text.txt"
invisible(file.create(temp_file))

text <- readtext::readtext(file = esp_text)
writeLines(text = text$text, con = temp_file)

new_text <- readLines(temp_file)
# remove instructions section
new_text <- new_text[stringr::str_which(new_text, "# Executive Summary"):length(new_text)]

cat(new_text, sep = "\n\n")
invisible(file.remove(temp_file))
}
```

\newpage

# Tables {-}

```{r, tables, message = FALSE}
# make traffic light table if creating report card
# or if traffic light table position isn't specified for other reports
if(params$esp_type == "report_card" |
   class(try(read.csv(file = tab_spreadsheet)))[1] == "try-error" |
   !"traffic light table" %in% try(read.csv(file = tab_spreadsheet))
   ) {
  child <- knitr::knit_child(system.file("table-child.Rmd", package = "AKesp"),
                  quiet = TRUE)
cat(child, sep = "\n\n")
} 

# make all other tables if table spreadsheet exists
if(params$esp_type != "report_card" &
   class(try(read.csv(file = tab_spreadsheet)))[1] != "try-error") {
  tabs <- read.csv(file = tab_spreadsheet)
  for (i in 1:nrow(tabs)) {
    cat("\n\n")
    tab <- tabs$file_name[i]
    AKesp::render_tab(
      lab = tabs$chunk_name[i],
      cap = tabs$caption[i]
    )
    cat("\n\n")
  }
}
```

\newpage

# Figures {-}
```{r, figures, fig.height = 8}
child <- knitr::knit_child(system.file("figure-child.Rmd", package = "AKesp"),
                  quiet = TRUE)
cat(child, sep = "\n\n")

# pull in extra figs if specified
if(params$esp_type != "report_card" &
   class(try(read.csv(file = fig_spreadsheet)))[1] != "try-error"){

  figs <- read.csv(file = fig_spreadsheet)
  for (i in 1:nrow(figs)) {
    try(AKesp::render_fig(
      img = figs$file_name[i],
      lab = figs$chunk_name[i],
      cap = figs$caption[i],
      alt = figs$alt_text[i]
    ))
    }
  }
```
