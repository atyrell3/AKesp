---
title: "Appendix `r params$num`. Ecosystem and Socioeconomic Profile of the `r params$fish` stock in the `r params$region` - Report Card"
author: "`r params$authors`"
date: "Draft `r params$year`"
output: 
  bookdown::word_document2:
    reference_docx: "template.docx"
    fig_caption: false
    
# bibliography: references.bib

params:
  num: 1
  authors: "Kalei Shotwell, Abby Tyrell"
  year: 2021
  contributors: "Kalei Shotwell, Abby Tyrell"
  fish: "Myfish"
  region: "Myarea"
  stock_image: system.file('images/noaa.jpg', package = 'AKesp')
  esp_data: AKesp::get_esp_data("Alaska Sablefish")
  con_model_path: system.file("images/noaa.jpg", package = "AKesp")
  bayes_path: system.file("images/noaa.jpg", package = "AKesp")
  ncolumn: 1
  min_year: NULL
---

```{r setup, include = FALSE}
# This template is specifically for an ESP report card
# The text content is read in from a word document
# The word document should be created based on the template
# Headings and table/figure references must follow specific formatting

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  results = "asis"
)

`%>%` <- magrittr::`%>%`
```

```{r, title-fig}
if (stringr::str_detect(params$stock_image, "system.file")) {
  img <- eval(parse(text = params$stock_image))
} else {
  img <- params$stock_image
}

knitr::include_graphics(path = img)
```

*With Contributions from:*

`r params$contributors`

\newpage

# Current Year Update {-}

The ecosystem and socioeconomic profile or ESP is a standardized framework for compiling and evaluating relevant stock-specific ecosystem and socioeconomic indicators and communicating linkages and potential drivers of the stock within the stock assessment process (Shotwell et al., In Review). The ESP process creates a traceable pathway from the initial development of indicators to management advice and serves as an on-ramp for developing ecosystem-linked stock assessments. 
Please refer to the last full ESP and partial ESP documents for further information regarding the ecosystem and socioeconomic linkages for this stock (*list references*).

## Management Considerations {-}

Summary conclusions from ESP for ABC (risk table) 

## Modeling Considerations {-}

Summary of indicators with high importance in the Bayesian adaptive sampling routine and discussion of which indicators have had consistent high importance. 
List of research ecosystem model runs that are currently ongoing and potential for operational use in the future. 

# Assessment {-}

## Ecosystem and Socioeconomic Processes {-}

One paragraph description of ecosystem and socioeconomic (if available) conceptual model(s)

## Indicator Suite {-}

One paragraph description of LME level indicators relevant to stock (ESR summary)

### Ecosystem Indicators: {-}
```{r, eco_ind} 
eco <- AKesp::list_indicators(data = params$esp_data, 
                              indicator_type = "Ecosystem")
cat(eco)
```

### Socioeconomic Indicators: {-}

```{r, socio_ind}
socio <- AKesp::list_indicators(data = params$esp_data, 
                                indicator_type = "Socioeconomic")
cat(socio, sep = "\n\n")
```

## Indicator Monitoring Analysis {-}

References for statistical tests for monitoring indicator suite by stage where relevant 

### Beginning Stage: Traffic Light Test {-}

One paragraph summary of indicator status and trends over time and last five years trend
Report scores by category (if applicable) and overall ecosystem and socioeconomic indicators. 

### Intermediate Stage: Importance Test {-}

One paragraph summary of importance results with analysis of highly explanatory variables for stock assessment input of interest (e.g., recruitment estimates)

### Advanced Stage: Research Model Test {-}

Update on ecosystem linked model in development and link to relevant literature or report on model 

# Data Gaps and Future Research Priorities {-}

Copy from full ESP

\newpage

# Tables {-}

```{r, table-set-up, message = FALSE}
dat <- params$esp_data %>%
  dplyr::mutate(INDICATOR_NAME = .data$INDICATOR_NAME %>%
    stringr::str_replace_all("_", " ") %>%
    stringr::str_wrap(width = 20))
```

```{r, eco-table}
this_dat <- dat %>%
  dplyr::filter(INDICATOR_TYPE == "Ecosystem")

AKesp::esp_traffic_tab_long(
  data = this_dat,
  year = (params$year - 4):params$year,
  cap = paste0("First stage ecosystem indicator analysis for ", params$fish, ', including indicator title and the indicator status of the last five years. The indicator status is designated with text, (greater than = "high", less than = "low", or within 1 standard deviation = "neutral" of long-term mean). Fill color of the cell is based on the sign of the anticipated relationship between the indicator and sablefish (blue = good conditions for sablefish, red = poor conditions, white = average conditions). A gray fill and text = "missing" will appear if there were no data for that year.')
) %>%
  flextable::width(j = 2, width = 2) %>%
  flextable::width(j = c(1, 3:6), width = 0.75)
```

```{r, socio-table, eval = "Socioeconomic" %in% params$esp_data$INDICATOR_TYPE}
this_dat <- dat %>%
  dplyr::filter(INDICATOR_TYPE == "Socioeconomic")

AKesp::esp_traffic_tab_long(
  data = this_dat,
  year = (params$year - 4):params$year,
  cap = paste0("First stage socioeconomic indicator analysis for ", params$fish, ', including indicator title and the indicator status of the last five years. The indicator status is designated with text, (greater than = "high", less than = "low", or within 1 standard deviation = "neutral" of long-term mean). Fill color of the cell is based on the sign of the anticipated relationship between the indicator and sablefish (blue = good conditions for sablefish, red = poor conditions, white = average conditions). A gray fill and text = "missing" will appear if there were no data for that year.')
) %>%
  flextable::width(j = 2, width = 2) %>%
  flextable::width(j = c(1, 3:6), width = 0.75)
```

\newpage

# Figures {-}
```{r, conceptual-model, fig.height = 8, eval = TRUE}
AKesp::render_fig(
  img = params$con_model_path,
  lab = "con-model",
  cap = paste0("Life history conceptual model for ", params$fish, " summarizing ecological information and key ecosystem processes affecting survival by life history stage. Red text means increases in process negatively affect survival, while blue text means increases in process positively affect survival."),
  alt = "Alt text"
)
```


```{r, traffic-eco, fig.height = 7, fig.width = 6}
alt <- "Alt text"
cap <- c("Selected ecosystem indicators for", params$fish, " with time series ranging from", min(params$esp_data$YEAR), "– present. Upper and lower solid green horizontal lines are 90th and 10th percentiles of time series. Dotted green horizontal line is the mean of the time series. Light green shaded areas represent the most recent year of the traffic light analysis results.")

knitr::opts_chunk$set(fig.cap = alt)
AKesp::esp_traffic_long(
  dat = params$esp_data %>%
    dplyr::filter(INDICATOR_TYPE == "Ecosystem"),
  paginate = TRUE,
  caption = cap,
  ncolumn = params$ncolumn,
  min_year = params$min_year
)
```


```{r, traffic-socio, fig.height = 7, fig.width = 6}
alt <- "Alt text"
cap <- c("Selected socioeconomic indicators for", params$fish, " with time series ranging from", min(params$esp_data$YEAR), "– present. Upper and lower solid green horizontal lines are 90th and 10th percentiles of time series. Dotted green horizontal line is the mean of the time series. Light green shaded areas represent the most recent year of the traffic light analysis results.")

knitr::opts_chunk$set(fig.cap = alt)
AKesp::esp_traffic_long(
  dat = params$esp_data %>%
    dplyr::filter(INDICATOR_TYPE == "Socioeconomic"),
  paginate = TRUE,
  caption = cap,
  ncolumn = params$ncolumn
)
```


```{r, overall, fig.height = 7, results = "asis"}
alt <- "Alt text"
cap <- c("Simple traffic light score for overall ecosystem and socioeconomic categories from 2000 to present.")

knitr::opts_chunk$set(fig.cap = alt)
AKesp::esp_overall_score(
  data = params$esp_data,
  species = params$fish,
  region = params$region
)

cat("##### Figure \\@ref(fig:overall).", cap, "{-}")
```


```{r, bayesian, fig.height = 8}
AKesp::render_fig(
  img = params$bayes_path,
  lab = "bayes",
  cap = paste0("Bayesian adaptive sampling output showing (a) standardized covariates prior to subsetting and (b) the mean relationship and uncertainty (95% confidence intervals) with log ", params$fish, " recruitment, in each estimated effect (left bottom graph), and marginal inclusion probabilities (right bottom graph) for each predictor variable of the subsetted covariate set"),
  alt = "Alt text"
)
```
